#2018/12/05 CP
#This script plots the relation between intra- and inter-group interaction coefficients
#2019/06/19 Changed Pearson pval to lm pval
#2019/12/26 Added lines to explore coefficients of interactions for seed bank thesis

rm(list=ls())
graphics.off()
library(MARSS)
source("script/matrix_MAR_clean.r")

#option_model=c("unconstrained","pencen")
option_model="pencen"
option_NEI=c("null") #We don't take the "Not Elsewhere Identified" species into account
groupe=c("BZ","MO","AR","SU")
option_sp="common" #Species are the same 
option_identify=FALSE #if true, print the name of the species instead of a dot (just an analysis tool)

methods=c("intra","mean_raw","mean_abs")

name_species=c("AST","CHA","DIT","GUI","LEP","NIT","PLE","PSE","RHI","SKE","THP","THL","GYM","PRO","PRP","SCR","CRY","EUG")

id_lieu=0

tab_vulnerability=array(NA,dim=c(10,length(option_model),length(name_species),length(methods)),dimnames=list(rep("",10),option_model,name_species,methods)) #10 subsites, 2 models, 21 species, 4 methods
tab_generality=array(NA,dim=c(10,length(option_model),length(name_species),length(methods)),dimnames=list(rep("",10),option_model,name_species,methods)) #10 subsites, 2 models, 21 species, 4 methods

n_inter=combn(name_species,2)
n_inter=apply(n_inter,2,paste,collapse='')

tab_sign=array(NA,dim=c(10,length(option_model),length(n_inter)),dimnames=list(rep("",10),option_model,n_inter))

colo=c()
#pch_sty=c() #If you want a different point shape for each region
pch_sty=rep(16,10)
for (g in groupe){
        if(g=="BZ"){
                option_lieu=c("Men er Roue","Loscolo","Croisic")
		colo=c(colo,rep("green",length(option_lieu)))
#		pch_sty=c(pch_sty,rep(15,length(option_lieu)))
        }else if(g=="MO"){
                option_lieu=c("LEperon","Cornard","Auger")
		colo=c(colo,rep("darkblue",length(option_lieu)))
#		pch_sty=c(pch_sty,rep(16,length(option_lieu)))
        }else if(g=="SU"){
                option_lieu=c("Antoine","Lazaret")
		colo=c(colo,rep("darkred",length(option_lieu)))
#		pch_sty=c(pch_sty,rep(17,length(option_lieu)))
        }else if(g=="AR"){
                option_lieu=c("Teychan","B7")
		colo=c(colo,rep("cyan",length(option_lieu)))
#		pch_sty=c(pch_sty,rep(18,length(option_lieu)))
        }
	for (ll in 1:length(option_lieu)){
		id_lieu=id_lieu+1
		dimnames(tab_vulnerability)[[1]][id_lieu]=option_lieu[ll]
		dimnames(tab_generality)[[1]][id_lieu]=option_lieu[ll]
		dimnames(tab_sign)[[1]][id_lieu]=option_lieu[ll]
        	for (m in 1:length(option_model)){
                        f1=paste("data/analyse_MAR/",g,"/site_specific/",option_lieu[ll],"_",option_model[m],"_",option_NEI,"_regular_common_",g,".RData",sep="")
                        load(f1)

			sp=dimnames(cis$model$data)[[1]] #Studied species
                        B=clean_matrix(cis)
			B_nodiag=B
			diag(B_nodiag)=NA
                        for (i in 1:length(sp)){
                                tab_vulnerability[id_lieu,option_model[m],sp[i],"intra"]=B[i,i]
                                tab_generality[id_lieu,option_model[m],sp[i],"intra"]=B[i,i]
             			tab_vulnerability[id_lieu,option_model[m],sp[i],"mean_raw"]=mean(B_nodiag[i,B_nodiag[i,]!=0],na.rm=T)
	             		tab_vulnerability[id_lieu,option_model[m],sp[i],"mean_abs"]=mean(abs(B_nodiag[i,B_nodiag[i,]!=0]),na.rm=T)
        	                tab_generality[id_lieu,option_model[m],sp[i],"mean_raw"]=mean(B_nodiag[B_nodiag[,i]!=0,i],na.rm=T)
                	        tab_generality[id_lieu,option_model[m],sp[i],"mean_abs"]=mean(abs(B_nodiag[B_nodiag[,i]!=0,i]),na.rm=T)
				if(i<length(sp)){
				for(j in (i+1):length(sp)){
					if(B[i,j]!=0){
					n_inter_tmp1=paste(sp[i],sp[j],sep="")
					n_inter_tmp2=paste(sp[j],sp[i],sep="")
					n_inter_tmp=intersect(c(n_inter_tmp1,n_inter_tmp2),n_inter)
					sg1=sign(B[i,j])
					sg2=sign(B[j,i])
					if(sg1*sg2<0){
						tab_sign[id_lieu,option_model[m],n_inter_tmp]=0
					}else{
						tab_sign[id_lieu,option_model[m],n_inter_tmp]=sg1
					}
					}
				}
				}
                        }

		}
	}
}

#Plotting now
let_gg=c("(a)","(b)","(c)","(d)")
for(m in 1:length(option_model)){
	if(option_identify){
	#pdf(paste("article/graphe/",option_model[m],"_generality_vs_vulnerability_testSP.pdf",sep=""),width=15,height=15)
	}else{
	pdf(paste("article/graphe/",option_model[m],"_generality_vs_vulnerability_MainFig_corrected_for_JEcol.pdf",sep=""))
	}
	par(mfrow=c(2,2),mar=c(4,4,.5,.75),oma=c(0.5,0.5,2,0.5))
	id_gg=0
	for(i in 1:2){
	#Set-up
	if(i==1){
		tab_tmp=tab_vulnerability
		aylab=c(expression('Vulnerability'~tilde(b[i.])),expression('Vulnerability'~bgroup("|",tilde(b[i.]),"|")))
		axlab=""
	}else{
		tab_tmp=tab_generality
		aylab=c(expression('Impact'~tilde(b[.i])),expression('Impact'~bgroup("|",tilde(b[.i]),"|")))
		axlab=expression("Self-regulation"~b[ii]-1)
	}

	xlimi=c(min(c(tab_tmp[,option_model[m],,"intra"]),na.rm=T),max(c(tab_tmp[,option_model[m],,"intra"]),na.rm=T))
	ylimi=c(min(c(tab_tmp[,option_model[m],,"mean_raw"]),na.rm=T),max(c(tab_tmp[,option_model[m],,"mean_raw"]),na.rm=T))
	id_gg=id_gg+1
	plot(0,0,t="n",ylab="",xlab="",xlim=xlimi,ylim=ylimi,cex.axis=1.2)
        mtext(let_gg[id_gg],side=3,cex=1.22*1.2,xpd=NA,font=1,line=0.5,adj=0)
        mtext(aylab[1],side=2,cex=1*1.2,line=2.2)
        mtext(axlab,side=1,cex=1*1.2,line=3)
	for(l in 1:dim(tab_tmp)[1]){
		if(option_identify){
			for(ssp in name_species){
				text(tab_tmp[l,option_model[m],ssp,"intra"],tab_tmp[l,option_model[m],ssp,"mean_raw"],labels=ssp,col=colo[l])
			}
		}else{
			points(tab_tmp[l,option_model[m],,"intra"],tab_tmp[l,option_model[m],,"mean_raw"],pch=pch_sty[l],col=colo[l])
		}
	}
	x1=c(tab_tmp[,option_model[m],,"intra"])
	y1=c(tab_tmp[,option_model[m],,"mean_raw"])
	lm1=lm(y1~x1)
	sumlm1=summary(lm1)
	abline(a=lm1$coefficients[1],b=lm1$coefficients[2])
	print(lm1$coefficients)
	#legend("topleft",paste("R2=",format(sumlm1$r.squared,digit=2),sep=""),bty="n")
	#legend("topleft",paste("p-val=",format(cor.test(x1,y1,use="complete.obs")[3],digit=1,nsmall=4),sep=""),bty="n")
	#legend(x=xlimi[1],y=ylimi[1]+(ylimi[2]-ylimi[1])*0.9,c(paste("p-val=",format(cor.test(x1,y1,use="complete.obs")[3],digit=1,nsmall=4),sep=""),paste("slope=",format(lm1$coefficients[2],digit=1,nsmall=4),sep="")),bty="n")
	legend(x=xlimi[1]-0.05,y=ylimi[1]+(ylimi[2]-ylimi[1])*0.9,c(paste("p-val=",format(sumlm1$coefficients["x1",4],digit=1,nsmall=4),sep=""),paste("slope=",format(lm1$coefficients[2],digit=1,nsmall=4),sep="")),bty="n",cex=1.2)

        ylimi=c(min(c(tab_tmp[,option_model[m],,"mean_abs"]),na.rm=T),max(c(tab_tmp[,option_model[m],,"mean_abs"]),na.rm=T))
        plot(0,0,t="n",xlab="",ylab="",xlim=xlimi,ylim=ylimi,cex.axis=1.2)
	if(id_gg==1){
	legend("topright",c("Brittany","OlÃ©ron","Arcachon","Mediterranean"),col=c("green","darkblue","cyan","darkred"),bty="n",pch=16,cex=1.2)
	}
	id_gg=id_gg+1
        mtext(let_gg[id_gg],side=3,cex=1.22*1.2,xpd=NA,font=1,line=0.5,adj=0)
        mtext(aylab[2],side=2,cex=1*1.2,line=2.2)
        mtext(axlab,side=1,cex=1*1.2,line=3)
	for(l in 1:dim(tab_tmp)[1]){
		if(option_identify){
			for(ssp in name_species){
				text(tab_tmp[l,option_model[m],ssp,"intra"],tab_tmp[l,option_model[m],ssp,"mean_abs"],labels=ssp,col=colo[l])
			}
		}else{
			points(tab_tmp[l,option_model[m],,"intra"],tab_tmp[l,option_model[m],,"mean_abs"],pch=pch_sty[l],col=colo[l])
		}
	}
	x1=c(tab_tmp[,option_model[m],,"intra"])
	y1=c(tab_tmp[,option_model[m],,"mean_abs"])
	lm1=lm(y1~x1)
	sumlm1=summary(lm1)
	abline(a=lm1$coefficients[1],b=lm1$coefficients[2])
	#legend("topleft",paste("R2=",format(sumlm1$r.squared,digit=2),sep=""),bty="n")
	#legend("topleft",paste("cor=",format(cor(x1,y1,use="complete.obs"),digit=2),sep=""),bty="n")
	#legend("topleft",paste("p-val=",format(cor.test(x1,y1,use="complete.obs")[3],nsmall=4,digits=1),sep=""),bty="n")
	#legend(x=xlimi[1],y=ylimi[1]+(ylimi[2]-ylimi[1])*0.9,c(paste("p-val=",format(cor.test(x1,y1,use="complete.obs")[3],nsmall=4,digits=1),sep=""),paste("slope=",format(lm1$coefficients[2],digit=1,nsmall=4),sep="")),bty="n")
	legend(x=xlimi[1]-0.05,y=ylimi[1]+(ylimi[2]-ylimi[1])*0.9,c(paste("p-val=",format(sumlm1$coefficients["x1",4],nsmall=4,digits=1),sep=""),paste("slope=",format(lm1$coefficients[2],digit=1,nsmall=4),sep="")),bty="n",cex=1.2)
	}	
	dev.off()
}
	y1=c(tab_generality[,option_model[m],,"intra"])
	x1=c(tab_generality[,option_model[m],,"mean_raw"])
	lm1=lm(y1~x1)
	sumlm1=summary(lm1)
	print(sumlm1)
tab_rank=matrix(NA,dim(tab_generality)[1],dim(tab_generality)[3],dimnames=list(dimnames(tab_generality)[[1]],dimnames(tab_generality)[[3]]))
for(l in 1:dim(tab_generality)[1]){
	val=tab_generality[l,option_model[m],,"mean_abs"]
	tmp_name=name_species[!is.na(val)]
	or_sp=order(val[tmp_name])
	tab_rank[l,tmp_name[or_sp]]=or_sp/max(or_sp)
}
pdf("ranking_sp.pdf",width=12)
par(mfrow=c(1,1))
plot(1:ncol(tab_rank),1:ncol(tab_rank),xlab="",xaxt="n",ylim=c(0,1),t="n")
axis(1,1:ncol(tab_rank),name_species)
for(s in 1:length(name_species)){
	points(rep(s,length(tab_rank[,s])),tab_rank[,s],pch=16)
}
dev.off()
#tmp_var=apply(tab_rank,2,mean,na.rm=T)
#print(tmp_var)

stop()
#testSP was not informative. Let's try stg else
pdf(paste("article/graphe/",option_model[m],"_generality_AND_vulnerability_link_with_SP.pdf",sep=""),width=13)
tab_tmp=tab_generality
ylimi=c(min(c(0,c(tab_tmp[,option_model[m],,"intra"])),na.rm=T),max(c(0,c(tab_tmp[,option_model[m],,"intra"])),na.rm=T))
plot(0,0,ylim=ylimi,xlim=c(1,length(name_species)*12.5),xlab="",ylab="self-regulation",t="n",xaxt="n")
axis(1,seq(5,length(name_species)*13,13),labels=name_species)
abline(h=mean(c(tab_tmp[,option_model[m],,"intra"]),na.rm=T),lty=2)
for(l in 1:dim(tab_tmp)[1]){
	for(ssp in 1:length(name_species)){
		rect(1+(ssp-1)*13+(l-1),0,1+(ssp-1)*13+(l-1)+1,tab_tmp[l,option_model[m],name_species[ssp],"intra"],col=colo[l])
	}
}
ylimi=c(min(c(0,c(tab_tmp[,option_model[m],,"mean_raw"])),na.rm=T),max(c(0,c(tab_tmp[,option_model[m],,"mean_raw"])),na.rm=T))
plot(0,0,ylim=ylimi,xlim=c(1,length(name_species)*12.5),xlab="",ylab="Raw generality",t="n",xaxt="n")
axis(1,seq(5,length(name_species)*13,13),labels=name_species)
abline(h=mean(c(tab_tmp[,option_model[m],,"mean_raw"]),na.rm=T),lty=2)
for(l in 1:dim(tab_tmp)[1]){
        for(ssp in 1:length(name_species)){
                rect(1+(ssp-1)*13+(l-1),0,1+(ssp-1)*13+(l-1)+1,tab_tmp[l,option_model[m],name_species[ssp],"mean_raw"],col=colo[l])
        }
}
ylimi=c(min(c(0,c(tab_tmp[,option_model[m],,"mean_abs"])),na.rm=T),max(c(0,c(tab_tmp[,option_model[m],,"mean_abs"])),na.rm=T))
plot(0,0,ylim=ylimi,xlim=c(1,length(name_species)*12.5),xlab="",ylab="Abs generality",t="n",xaxt="n")
axis(1,seq(5,length(name_species)*13,13),labels=name_species)
abline(h=mean(c(tab_tmp[,option_model[m],,"mean_abs"]),na.rm=T),lty=2)
for(l in 1:dim(tab_tmp)[1]){
        for(ssp in 1:length(name_species)){
                rect(1+(ssp-1)*13+(l-1),0,1+(ssp-1)*13+(l-1)+1,tab_tmp[l,option_model[m],name_species[ssp],"mean_abs"],col=colo[l])
        }
}
tab_tmp=tab_vulnerability
ylimi=c(min(c(0,c(tab_tmp[,option_model[m],,"mean_raw"])),na.rm=T),max(c(0,c(tab_tmp[,option_model[m],,"mean_raw"])),na.rm=T))
plot(0,0,ylim=ylimi,xlim=c(1,length(name_species)*12.5),xlab="",ylab="Raw vulnerability",t="n",xaxt="n")
axis(1,seq(5,length(name_species)*13,13),labels=name_species)
abline(h=mean(c(tab_tmp[,option_model[m],,"mean_raw"]),na.rm=T),lty=2)
for(l in 1:dim(tab_tmp)[1]){
        for(ssp in 1:length(name_species)){
                rect(1+(ssp-1)*13+(l-1),0,1+(ssp-1)*13+(l-1)+1,tab_tmp[l,option_model[m],name_species[ssp],"mean_raw"],col=colo[l])
        }
}
ylimi=c(min(c(0,c(tab_tmp[,option_model[m],,"mean_abs"])),na.rm=T),max(c(0,c(tab_tmp[,option_model[m],,"mean_abs"])),na.rm=T))
plot(0,0,ylim=ylimi,xlim=c(1,length(name_species)*12.5),xlab="",ylab="Abs vulnerability",t="n",xaxt="n")
axis(1,seq(5,length(name_species)*13,13),labels=name_species)
abline(h=mean(c(tab_tmp[,option_model[m],,"mean_abs"]),na.rm=T),lty=2)
for(l in 1:dim(tab_tmp)[1]){
        for(ssp in 1:length(name_species)){
                rect(1+(ssp-1)*13+(l-1),0,1+(ssp-1)*13+(l-1)+1,tab_tmp[l,option_model[m],name_species[ssp],"mean_abs"],col=colo[l])
        }
}
dev.off()

#Still can't see anything. PCA ? NO. We have too many missing values.
#name_present=c("CHA","GUI","LEP","NIT","PSE","PLE","SKE","PRO","PRP") #species present in 3 regions out of 4
name_present=name_species #test on sites
tab_tmp=tab_generality[,option_model[m],name_present,]
test="mean_abs"
for(l in 1:dim(tab_tmp)[1]){
	print(dimnames(tab_tmp)[[1]][l])
	id_na=is.na(tab_tmp[l,,test])
	plou=order(tab_tmp[l,!id_na,test])
	print(name_present[!id_na][plou])
}

#Relevant interactions
relevant_interaction=c()
for(i in 1:length(n_inter)){
	if(sum(!is.na(tab_sign[,1,n_inter[i]]))>=2){ 
		relevant_interaction=c(relevant_interaction,n_inter[i])
	}
}
print(tab_sign[,1,relevant_interaction])
