#Handling of the files, at first

graphics.off()
rm(list=ls())
source("/home/cpicoche/Documents/Plankton/script/functions_global.r")

corres=read.table("data/lieu_corres.csv",sep=";",header=TRUE)

filename_tot=c("data/raw/Q2_170418_site_Tania_UTF8_only_good.csv","data/raw/Q2_170511_SRN_Chnord_UTF8_only_good.csv")
#filename_tot=c("Q2_170511_SRN_Chnord_UTF8_only_good.csv")

#file.remove(paste("data/",list.files(pattern='*.flortot_only.csv'),sep=""))
for (filename in filename_tot){
tab=read.table(filename,sep=";",header=TRUE)
date=as.Date(tab$Date,"%d/%m/%Y")

l_u=unique(tab$Lieu_id)
d_min=min(date)
d_max=max(date)

for (l in 1:length(l_u)){
	        tab_flore=subset(tab,((Lieu_id==l_u[l])&(Res_code=="FLORTOT")),select=c("Lieu_id","Lieu_libel","Date","Imm","Taxon","Val"))
		if (dim(tab_flore)[1]!=0){
		tab_flore$Date=as.Date(tab_flore$Date,"%d/%m/%Y")
		libel=tab_flore$Lieu_libel[1]
		date_flore=sort(unique(as.Date(tab_flore$Date,"%d/%m/%Y")))
                tab_flore1=mat_taxon_pour_comparaison(tab_flore)
                tab_flore=mat_conv_genus(tab_flore1)
	
		tab_final=cbind(as.character(date_flore),tab_flore)
	        colnames(tab_final)[1]="Date"

		new_name=paste(l_u[l],"_flortot_only.csv",sep="")

		if(length(list.files(path="data/",pattern=new_name))>0){
			print(libel)
			tab1=read.table(paste("data/",new_name,sep=""),sep=";",header=TRUE)
			date1=as.Date(tab1$Date)
			d1=min(date1)
			d2=max(date1)

			tab_final=rbind(tab_final[date_flore<d1,],tab1,tab_final[date_flore>d2,])
		}

                write.table(tab_final,file=paste("data/",new_name,sep=""),na="NA",sep=";",dec=".",col.names=TRUE,row.names=FALSE)
	
		}
}
}
		
#Correction : si deux sites sont utilisés pour la même flore, il peut y avoir des overlaps, on va donc doubler artificiellement la pop de plancton
nb_site=unique(corres$Lieu_corres)
for (n in 1:length(nb_site)){
	id=corres$Lieu_id[corres$Lieu_corres==nb_site[n]]
	ll=corres$Lieu_mnemonique[corres$Lieu_corres==nb_site[n]]
	if (length(id)>1){ #There are two names for the same site
		tab1=read.table(paste("data/",id[1],"_flortot_only.csv",sep=""),sep=";",header=TRUE)
		date1=as.Date(tab1$Date)
		tab2=read.table(paste("data/",id[2],"_flortot_only.csv",sep=""),sep=";",header=TRUE)
		date2=as.Date(tab2$Date)

		if(min(date1)>min(date2)){ 
			tmp=tab1
			tab1=tab2
			tab2=tmp
			date1=as.Date(tab1$Date)
			date2=as.Date(tab2$Date)
		}	
	
		for (d in 1:length(date2)){
			if (is.element(date2[d],date1[d])){
				tab1=tab1[-d]
			}
		}

		tab_tot=rbind(tab1,tab2)

                write.table(tab_tot,file=paste("data/",ll[1],"-",ll[2],"_flortot_only.csv",sep=""),na="NA",sep=";",dec=".",col.names=TRUE,row.names=FALSE)
	}else{
		
		tab_tot=read.table(paste("data/",id[1],"_flortot_only.csv",sep=""),sep=";",header=TRUE)
                write.table(tab_tot,file=paste("data/",ll[1],"_flortot_only.csv",sep=""),na="NA",sep=";",dec=".",col.names=TRUE,row.names=FALSE)
	}
}

